rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions for authentication and authorization
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return isAuthenticated() && 
             (request.auth.token.admin == true ||
              request.auth.token.role == 'admin' ||
              request.auth.token.email == '9alvaro0@gmail.com' ||
              request.auth.token.email_verified == true && 
              request.auth.token.email == '9alvaro0@gmail.com');
    }
    
    function isOwner(userId) {
      return isAuthenticated() && 
             request.auth.uid == userId;
    }
    
    function hasValidRole(role) {
      return role in ['admin', 'editor', 'author', 'user', 'guest'];
    }
    
    function isValidEmail(email) {
      return email is string && 
             email.matches('.*@.*\\..*');
    }
    
    // Posts collection rules
    match /posts/{postId} {
      // Read rules: Published posts are public, drafts only for admins/authors
      // Public access to published posts
      allow read: if resource.data.isPublished == true;
      
      // Admins can read all posts
      allow read: if isAdmin();
      
      // Authors can read their own posts
      allow read: if isAuthenticated() && request.auth.uid == resource.data.authorId;
      
      // Allow list operation for published posts (public)
      allow list: if true;
      
      // Allow list operation for admins to see all posts in admin panel
      allow list: if isAdmin();
      
      // Create rules: Only admins and editors can create posts
      allow create: if isAdmin() || 
                       (isAuthenticated() && 
                        request.auth.token.role in ['admin', 'editor', 'author'] &&
                        request.auth.uid == request.resource.data.authorId &&
                        // Validate required fields
                        request.resource.data.keys().hasAll(['title', 'content', 'authorId', 'createdAt']) &&
                        request.resource.data.title is string &&
                        request.resource.data.title.size() > 0 &&
                        request.resource.data.content is string &&
                        request.resource.data.content.size() > 0);
      
      // Update rules: Admins can update any, authors can update their own
      allow update: if isAdmin() ||
                       (isAuthenticated() && 
                        request.auth.uid == resource.data.authorId &&
                        // Ensure author can't change ownership
                        request.resource.data.authorId == resource.data.authorId);
      
      // Delete rules: Only admins can delete posts
      allow delete: if isAdmin();
    }
    
    // Comments collection rules
    match /comments/{commentId} {
      // Read rules: All comments are public
      allow read: if true;
      
      // Create rules: Authenticated users can create comments
      allow create: if isAuthenticated() &&
                       request.auth.uid == request.resource.data.authorId &&
                       // Validate required fields
                       request.resource.data.keys().hasAll(['content', 'authorId', 'postId', 'createdAt']) &&
                       request.resource.data.content is string &&
                       request.resource.data.content.size() > 0 &&
                       request.resource.data.content.size() <= 1000 &&
                       // Rate limiting: max 5 comments per minute per user
                       request.time > resource.data.createdAt + duration.value(1, 'm') ||
                       !exists(/databases/$(database)/documents/comments/$(commentId));
      
      // Update rules: Users can edit their own comments, admins can edit any
      allow update: if isOwner(resource.data.authorId) ||
                       isAdmin();
      
      // Delete rules: Users can delete their own comments, admins can delete any
      allow delete: if isOwner(resource.data.authorId) ||
                       isAdmin();
    }
    
    // Users collection rules
    match /users/{userId} {
      // Read rules: Users can read their own profile, admins can read any
      allow read: if isOwner(userId) ||
                     isAdmin();
      
      // Allow list operation for admins to see all users in admin panel
      allow list: if isAdmin();
      
      // Create rules: Users can create their own profile during registration
      allow create: if isOwner(userId) &&
                       // Validate required fields
                       request.resource.data.keys().hasAll(['uid', 'email', 'createdAt']) &&
                       request.resource.data.uid == userId &&
                       isValidEmail(request.resource.data.email) &&
                       // Allow role to be set during registration (defaults to 'user')
                       (request.resource.data.role == null || 
                        request.resource.data.role == 'user' || 
                        hasValidRole(request.resource.data.role));
      
      // Update rules: Users can update their own profile, admins can update any
      allow update: if isOwner(userId) ||
                       isAdmin();
      
      // Delete rules: Only admins can delete user accounts
      allow delete: if isAdmin();
    }
    
    // Authors collection rules (public profile data for posts)
    match /authors/{authorId} {
      // Read rules: Authors data is public for displaying in posts
      allow read: if true;
      
      // Create/Update rules: Users can manage their own author profile, admins can manage any
      allow create, update: if isOwner(authorId) ||
                               isAdmin();
      
      // Delete rules: Only admins can delete author profiles
      allow delete: if isAdmin();
    }
    
    
    // Tags collection rules
    match /tags/{tagId} {
      // Read rules: Tags are public
      allow read: if true;
      
      // Create/Update/Delete rules: Only admins and editors can manage tags
      allow write: if isAdmin() || 
                      (isAuthenticated() && 
                       request.auth.token.role in ['admin', 'editor']);
    }
    
    // Newsletter collection rules
    match /newsletter/{subscriberId} {
      // Read rules: Only admins can read newsletter subscriptions
      allow read: if isAdmin();
      
      // Allow list operation for admins to see all newsletter subscriptions
      allow list: if isAdmin();
      
      // Create rules: Anyone can subscribe to newsletter
      allow create: if request.resource.data.keys().hasAll(['email', 'createdAt']) &&
                       isValidEmail(request.resource.data.email);
      
      // Update/Delete rules: Only admins can manage subscriptions
      allow update, delete: if isAdmin();
    }
    
    // Newsletter subscribers collection rules (used by the service)
    match /newsletterSubscribers/{subscriberId} {
      // Allow all operations for newsletter subscription to work properly
      // Allow list operation for admins to see all newsletter subscriptions
      allow read, write: if true;
      allow list: if isAdmin() || true;
    }
    
    // Analytics and stats collections (read-only for users, write for system)
    match /analytics/{document} {
      allow read: if isAdmin();
      allow write: if false; // Only server-side functions should write analytics
    }
    
    // System configuration (admin only)
    match /config/{configId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }
    
    // Contact form submissions
    match /contacts/{contactId} {
      // Create rules: Anyone can submit contact form
      allow create: if request.resource.data.keys().hasAll(['name', 'email', 'message', 'createdAt']) &&
                       request.resource.data.name is string &&
                       request.resource.data.name.size() > 0 &&
                       isValidEmail(request.resource.data.email) &&
                       request.resource.data.message is string &&
                       request.resource.data.message.size() > 0 &&
                       request.resource.data.message.size() <= 2000;
      
      // Read/Update/Delete rules: Only admins can manage contact submissions
      allow read, update, delete: if isAdmin();
    }
    
    // Deny all other collections by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}